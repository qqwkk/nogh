/*
 * PlainChess v1.22
 * http://plainchess.timwoelfle.de
 *
 * Copyright by Tim Wölfle (http://timwoelfle.de)
 * Licensed under the GPL Version 3 license (http://www.gnu.org/licenses/gpl-3.0.txt)
 *
 */
var game,sync,menu,controller;function Game(savedGame){var pieceSymbols={"♙":{color:"white",kind:"pawn"},"♘":{color:"white",kind:"knight"},"♗":{color:"white",kind:"bishop"},"♖":{color:"white",kind:"rook"},"♕":{color:"white",kind:"queen"},"♔":{color:"white",kind:"king"},"♟":{color:"black",kind:"pawn"},"♞":{color:"black",kind:"knight"},"♝":{color:"black",kind:"bishop"},"♜":{color:"black",kind:"rook"},"♛":{color:"black",kind:"queen"},"♚":{color:"black",kind:"king"}};var gameTime=0;var moves=[];var gameState;var whitesTurn=1;var castlingAllowed={white:{queenSide:true,kingSide:true},black:{queenSide:true,kingSide:true}};var field={};var timerInterval;var showCaptionInterval;var gameOver;var clickedPieceIsMoving;function generateNotationString(move){var notationString;if(pieceSymbols[move.pieceSymbol].kind==="king"&&Math.abs(move.startColumn-move.endColumn)>1){return move.endColumn===3?"O-O-O":"O-O"}notationString=pieceSymbols[move.pieceSymbol].color==="white"?move.pieceSymbol:'<span style="color: black">'+move.pieceSymbol+"</span>";notationString+=String.fromCharCode(96+move.startColumn);notationString+=move.startRow;notationString+=" ";if(move.capturedPieceSymbol){notationString+=pieceSymbols[move.capturedPieceSymbol].color==="white"?move.capturedPieceSymbol:'<span style="color: black">'+move.capturedPieceSymbol+"</span>"}notationString+=String.fromCharCode(96+move.endColumn);notationString+=move.endRow;if(move.promotionType){notationString+="=";notationString+=pieceSymbols[move.pieceSymbol].color==="white"?move.promotionType:'<span style="color: black">'+move.promotionType+"</span>"}else if(move.enPassant){notationString+=" e.p."}if(move.check&&!move.mate){notationString+="+"}if(move.mate||move.stalemate){notationString+="#"}return notationString}function updateInfoDrawer(){var lastMove=moves[moves.length-1];var currentTurnString="";var lastMoveString;if(lastMove&&lastMove.stalemate){currentTurnString="Stalemate!"}else{if(lastMove&&lastMove.mate){currentTurnString="Mate! ";if(sync){currentTurnString+=whitesTurn===sync.playerIsWhite?"Opponent wins.":"You win."}else{currentTurnString+=whitesTurn?"Black wins.":"White wins."}}else{if(lastMove&&lastMove.check){currentTurnString="Check! "}if(sync){currentTurnString+=whitesTurn===sync.playerIsWhite?"Your turn.":"Opponent's turn."}else{currentTurnString+=whitesTurn?"White's turn.":"Black's turn."}}}$("#currentTurn > span:first-child").html(currentTurnString);if(moves.length){lastMoveString="Last move: "+generateNotationString(lastMove)}else{lastMoveString="No move yet."}$("#lastMove").html(lastMoveString)}function updateGameTime(){var min;var sec;var string="";gameTime++;min=Math.floor(gameTime/60);sec=gameTime%60;string+=min<10?"0"+min:min;string+=":";string+=sec<10?"0"+sec:sec;$("#gameTime").html(string)}function hidePromotionMenu(){$(".promotion").fadeOut(300,function(){$(".promotion > ul > li").off().remove();$(".promotion")[0].id="";$(".promotion").css("left","")})}function hideInfoDrawer(){if($("#info").height()===570){$("#info").clearQueue().animate({height:"540px"},100,"easeOutQuad")}}function showInfoDrawer(){if($("#info").height()===540){$("#info").clearQueue().animate({height:"570px"},100,"easeInQuad")}}function pieceObject(element,object){if(!object)return $(element).data("pieceObject");else return $(element).data("pieceObject",object)}function fieldObject(element,object){if(!object)return $(element).data("fieldObject");else return $(element).data("fieldObject",object)}function finishMove(){var possibleTurn;whitesTurn=whitesTurn?0:1;if(pieceObject($("td > .piece.king."+(whitesTurn?"white":"black"))).field.reachableBy[whitesTurn?"black":"white"].length){moves[moves.length-1].check=true}$(whitesTurn?"td > .white":"td> .black").each(function(index,piece){if(pieceObject(piece).accessibleFields().length){possibleTurn=true;return false}});if(!possibleTurn){if(moves[moves.length-1].check){moves[moves.length-1].mate=true;$("#end > .tone100 > h2 > span:first-child").css("background-position",whitesTurn?"-180px 100%":"0 100%");$("#end > .tone100 > h2 > span:last-child").html(whitesTurn?"Black wins":"White wins")}else{moves[moves.length-1].stalemate=true;$("#end > .tone100 > h2 > span:first-child").css("background-position","-360px 100%");$("#end > .tone100 > h2 > span:last-child").html("Stalemate")}game.gameOver=true;clearInterval(timerInterval)}if(moves[moves.length-1].check){if(moves[moves.length-1].mate){controller.blink($("td > .piece.king."+(whitesTurn?"white":"black")),3,1e3,function(){if(!menu){menu=new Menu("#end");menu.appear(true)}})}else{controller.blink($("td > .piece.king."+(whitesTurn?"white":"black")),2,1e3)}}else if(moves[moves.length-1].stalemate){controller.blink($("td > .piece.king"),3,1e3,function(){if(!menu){menu=new Menu("#end");menu.appear(true)}})}updateInfoDrawer();if(controller.autoSave){game.updateLocalStorage()}if(sync&&sync.playerIsWhite!==whitesTurn){sync.makeMove(moves[moves.length-1])}}function Piece(pieceElement){var that=this;pieceObject(pieceElement,this);this.element=pieceElement;this.symbol=pieceElement.innerHTML;this.kind=pieceSymbols[this.symbol].kind;this.color=pieceSymbols[this.symbol].color;this.isWhite=this.color==="white"?1:0;this.field=fieldObject(pieceElement.parentNode);this.reachableFields=[];function removeCastlingRights(){if(that.kind==="king"||that.kind==="rook"&&that.field.column===1){castlingAllowed[that.color].queenSide=false}if(that.kind==="king"||that.kind==="rook"&&that.field.column===8){castlingAllowed[that.color].kingSide=false}}this.getReachableFields=function(){function Fields(column,row){this.add=function(columnDiff,rowDiff){if(field[column+columnDiff]&&field[column+columnDiff][row+rowDiff]){return this.push(field[column+columnDiff][row+rowDiff])}return false}}Fields.prototype=[];var fields=new Fields(this.field.column,this.field.row);var forward=that.isWhite?+1:-1;var i;switch(this.kind){case"pawn":fields.add(-1,forward);fields.add(+1,forward);break;case"knight":fields.add(-1,+2);fields.add(+1,+2);fields.add(-1,-2);fields.add(+1,-2);fields.add(-2,+1);fields.add(-2,-1);fields.add(+2,+1);fields.add(+2,-1);break;case"king":fields.add(-1,+1);fields.add(+0,+1);fields.add(+1,+1);fields.add(-1,+0);fields.add(+1,+0);fields.add(-1,-1);fields.add(+0,-1);fields.add(+1,-1);break;case"bishop":case"rook":case"queen":if(this.kind!=="bishop"){$.each([[-1,0],[+1,0],[0,-1],[0,+1]],function(index,coords){for(i=1;fields.add(coords[0]*i,coords[1]*i);i++){if(fields[fields.length-1].piece){break}}})}if(this.kind!=="rook"){$.each([[-1,+1],[-1,-1],[+1,+1],[+1,-1]],function(index,coords){for(i=1;fields.add(coords[0]*i,coords[1]*i);i++){if(fields[fields.length-1].piece){break}}})}break}return fields};this.captureableFields=function(){var otherFields=this.reachableFields;var fields=[];$.each(otherFields,function(index,otherField){if(otherField.piece){if(otherField.piece.isWhite!==that.isWhite){fields.push(otherField)}}else if(that.kind!=="pawn"){fields.push(otherField)}});return fields};this.accessibleFields=function(){var fields=this.captureableFields();var forward=that.isWhite?1:-1;var homeRow=that.isWhite?1:8;var cachedFields;var king=pieceObject($("td > .piece.king."+(that.isWhite?"white":"black")));var opponentColor=that.isWhite?"black":"white";var aggressors=king.field.reachableBy[opponentColor];var i;var lineFld;var behindPiece;switch(this.kind){case"pawn":if(field[this.field.column][this.field.row+forward]&&!field[this.field.column][this.field.row+forward].piece){fields.push(field[this.field.column][this.field.row+forward])}if(this.field.row===homeRow+forward&&!field[this.field.column][this.field.row+forward].piece&&!field[this.field.column][this.field.row+forward*2].piece){fields.push(field[this.field.column][this.field.row+forward*2])}if(this.field.row===homeRow+forward*4&&moves.length&&pieceSymbols[moves[moves.length-1].pieceSymbol].kind==="pawn"&&moves[moves.length-1].endRow===this.field.row&&Math.abs(moves[moves.length-1].startRow-moves[moves.length-1].endRow)===2&&Math.abs(moves[moves.length-1].startColumn-this.field.column)===1){fields.push(field[moves[moves.length-1].startColumn][this.field.row+forward])}break;case"king":if(castlingAllowed[this.color].queenSide&&field[1][homeRow].piece&&field[1][homeRow].piece.kind==="rook"&&!field[2][homeRow].piece&&!field[3][homeRow].piece&&!field[4][homeRow].piece&&!field[3][homeRow].reachableBy[opponentColor].length&&!field[4][homeRow].reachableBy[opponentColor].length&&!field[5][homeRow].reachableBy[opponentColor].length){fields.push(field[3][homeRow])}if(castlingAllowed[this.color].kingSide&&field[8][homeRow].piece&&field[8][homeRow].piece.kind==="rook"&&!field[6][homeRow].piece&&!field[7][homeRow].piece&&!field[7][homeRow].reachableBy[opponentColor].length&&!field[6][homeRow].reachableBy[opponentColor].length&&!field[5][homeRow].reachableBy[opponentColor].length){fields.push(field[7][homeRow])}$.each(fields,function(index,fld){if(fld.reachableBy[opponentColor].length){fields[index]=[]}else{$.each(aggressors,function(aggressorIndex,aggressor){if(["rook","queen"].includes(aggressor.kind)&&that.field.inBetweenCross(aggressor.field,fld))fields[index]=[];if(["bishop","queen"].includes(aggressor.kind)&&that.field.inBetweenDiag(aggressor.field,fld))fields[index]=[]})}});return fields.flat()}if(aggressors.length){cachedFields=fields;fields=[];if(aggressors.length>1){return[]}else{$.each(cachedFields,function(index,fld){if(aggressors[0].kind==="bishop"||aggressors[0].kind==="rook"||aggressors[0].kind==="queen"){if(fld.inBetween(king.field,aggressors[0].field)){fields.push(fld)}}if(fld===aggressors[0].field){fields.push(fld)}})}}$.each([[-1,0],[+1,0],[0,-1],[0,+1],[-1,+1],[-1,-1],[+1,+1],[+1,-1]],function(index,coords){if(!field[that.field.column+coords[0]]||!(lineFld=field[that.field.column+coords[0]][that.field.row+coords[1]])){return true}if(that.field.inBetween(lineFld,king.field)){for(i=1;field[king.field.column+coords[0]*i]&&(lineFld=field[king.field.column+coords[0]*i][king.field.row+coords[1]*i]);i++){if(lineFld.piece){if(lineFld.piece===that){behindPiece=true;continue}else if(behindPiece&&lineFld.piece.isWhite!==that.isWhite&&(lineFld.piece.kind==="queen"||lineFld.piece.kind==="bishop"&&index>3||lineFld.piece.kind==="rook"&&index<4)){cachedFields=fields;fields=[];$.each(cachedFields,function(index,cachedFld){if(cachedFld.inBetween(king.field,lineFld)||cachedFld===lineFld){fields.push(cachedFld)}})}return false}}}});return fields};this.updateReachables=function(){function updatePropertyClass(fld){if(fld.reachableBy.white.length!==fld.reachableBy.black.length)fld.element.className="property"+(fld.reachableBy.white.length-fld.reachableBy.black.length);else fld.element.className="neutral"+fld.reachableBy.white.length}$.each(this.reachableFields,function(index,fld){index=fld.reachableBy[that.color].indexOf(that);if(index!==-1){fld.reachableBy[that.color].splice(index,1);updatePropertyClass(fld)}});if(!this.field){return false}this.reachableFields=this.getReachableFields();$.each(this.reachableFields,function(index,fld){fld.reachableBy[that.color].push(that);updatePropertyClass(fld)})};this.moveToCemetery=function(){var target;if(this.kind==="rook"){removeCastlingRights()}target=$("<li />").appendTo($("#"+this.color+"Cemetery"));this.moveInDOM(target,true,true);if($(pieceElement).hasClass("ui-draggable")){$(pieceElement).draggable("destroy")}};this.move=function(targetField,promotionType){var capturedPiece,castling;moves.push({startColumn:that.field.column,startRow:that.field.row,endColumn:targetField.column,endRow:targetField.row,pieceSymbol:that.symbol});capturedPiece=field[targetField.column][targetField.row].piece;if(that.kind==="pawn"&&that.field.column!==targetField.column&&!capturedPiece){capturedPiece=field[targetField.column][targetField.row+(that.isWhite?-1:1)].piece;moves[moves.length-1].enPassant=true}if(capturedPiece){moves[moves.length-1].capturedPieceSymbol=capturedPiece.symbol;capturedPiece.moveToCemetery()}if((that.symbol==="♔"&&targetField.row===1||that.symbol==="♚"&&targetField.row===8)&&(targetField.column===3&&castlingAllowed[that.color].queenSide||targetField.column===7&&castlingAllowed[that.color].kingSide)){castling={};castling.row=that.symbol==="♔"?1:8;castling.startColumn=targetField.column===3?1:8;castling.endColumn=targetField.column===3?4:6;castling.tower=field[castling.startColumn][castling.row].piece;castling.tower.moveInDOM(field[castling.endColumn][castling.row].element,true)}if(that.kind==="rook"||that.kind==="king"){removeCastlingRights()}that.moveInDOM(targetField.element);if(that.symbol==="♙"&&targetField.row===8||that.symbol==="♟"&&targetField.row===1){return that.promote(promotionType)}finishMove()};this.animateMove=function(targetField,promotionType){$(pieceElement).css("position","relative").animate({left:$(targetField.element).offset().left-$(this.field.element).offset().left,top:$(targetField.element).offset().top-$(this.field.element).offset().top},1e3,"easeInOutQuad",function(){if(clickedPieceIsMoving){clickedPieceIsMoving=false}that.move(targetField,promotionType)})};this.startDragging=function(){var fields;$("#board td").removeClass("acceptable").off("click");if(whitesTurn!==this.isWhite||clickedPieceIsMoving||moves[moves.length-1]&&(moves[moves.length-1].mate||moves[moves.length-1].stalemate)||$(".promotion").is(":visible")){return false}$("#board td").droppable("option","accept","");fields=this.accessibleFields();$.each(fields,function(index,fld){$(fld.element).droppable("option","accept",".piece")});return true};this.clickPiece=function(){if(whitesTurn!==this.isWhite||clickedPieceIsMoving||moves[moves.length-1]&&(moves[moves.length-1].mate||moves[moves.length-1].stalemate)||$(".promotion").is(":visible")){return true}function unselect(){$("#board td").removeClass("acceptable").off("click")}unselect();$("#board td").on("click",function(){unselect()});$.each(this.accessibleFields(),function(index,fld){$(fld.element).addClass("acceptable");$(fld.element).on("click",function(){clickedPieceIsMoving=true;unselect();that.animateMove(fld)})});return false};this.promote=function(pieceSymbol){if(pieceSymbol){that.symbol=pieceElement.innerHTML=pieceSymbol;that.kind=pieceSymbols[pieceSymbol].kind;moves[moves.length-1].promotionType=pieceSymbol;gameState[moves[moves.length-1].endColumn][moves[moves.length-1].endRow]=pieceSymbol;that.updateReachables();finishMove();hidePromotionMenu();controller.flip(pieceElement,"horizontal",1e3,function(){$(pieceElement).removeClass("pawn");$(pieceElement).addClass(that.kind)})}else{var mirroredBoardOrientation;$.each(this.isWhite?["♘","♗","♖","♕"]:["♞","♝","♜","♛"],function(index,pieceSymbol){$('<li><div class="piece '+pieceSymbols[pieceSymbol].color+" "+pieceSymbols[pieceSymbol].kind+'">'+pieceSymbol+"</div></li>").appendTo($(".promotion > ul")).on("click",function(){that.promote(pieceSymbol)})});mirroredBoardOrientation=sync?!sync.playerIsWhite:0;$(".promotion")[0].id=this.isWhite||mirroredBoardOrientation?"top":"bottom";$(".promotion").css("left",-130+60*Math.abs(this.field.column-9*mirroredBoardOrientation)+"px");$(".promotion").fadeIn(300)}};this.moveInDOM=function(target,animated,spin){var oldFieldsReachables,oldPosLeft,oldPosTop;oldFieldsReachables=this.field.reachableBy.white.concat(this.field.reachableBy.black);gameState[this.field.column][this.field.row]="";this.field.piece=undefined;this.field=undefined;$.each(oldFieldsReachables,function(index,piece){if(piece.kind==="bishop"||piece.kind==="rook"||piece.kind==="queen"){piece.updateReachables()}});if(animated){oldPosLeft=$(pieceElement).offset().left;oldPosTop=$(pieceElement).offset().top}$(target).append(pieceElement);if(animated){if(spin){controller.spin(pieceElement,1e3)}$(pieceElement).css({position:"relative",left:oldPosLeft-$(pieceElement).offset().left+"px",top:oldPosTop-$(pieceElement).offset().top+"px"}).animate({left:"0",top:"0"},1e3,"easeInOutQuad")}else{$(pieceElement).css({left:"0",top:"0"})}if(fieldObject(target)){gameState[fieldObject(target).column][fieldObject(target).row]=this.symbol;this.field=fieldObject(target);this.field.piece=this;$.each(this.field.reachableBy.white.concat(this.field.reachableBy.black),function(index,piece){if(piece.kind==="bishop"||piece.kind==="rook"||piece.kind==="queen"){piece.updateReachables()}})}this.updateReachables()}}function Field(fieldElement){fieldObject(fieldElement,this);this.element=fieldElement;this.column=parseInt(fieldElement.id.substr(0,1),10);this.row=parseInt(fieldElement.id.substr(1,1),10);this.piece=fieldElement.firstChild?pieceObject(fieldElement.firstChild):undefined;this.reachableBy={white:[],black:[]};this.createPiece=function(pieceSymbol){this.piece=new Piece($('<div class="piece '+pieceSymbols[pieceSymbol].color+" "+pieceSymbols[pieceSymbol].kind+'">'+pieceSymbol+"</div>").appendTo(fieldElement)[0])};this.inBetweenCross=function(startField,endField){if(startField.column===endField.column&&this.column===startField.column){return this.row<startField.row&&this.row>endField.row||this.row>startField.row&&this.row<endField.row}else if(startField.row===endField.row&&this.row===startField.row){return this.column<startField.column&&this.column>endField.column||this.column>startField.column&&this.column<endField.column}return false};this.inBetweenDiag=function(startField,endField){if(Math.abs(startField.column-endField.column)===Math.abs(startField.row-endField.row)){return Math.abs(startField.column-this.column)===Math.abs(startField.row-this.row)&&Math.abs(startField.column-this.column)<Math.abs(startField.column-endField.column)&&Math.abs(endField.column-this.column)<Math.abs(startField.column-endField.column)&&Math.abs(startField.row-this.row)<Math.abs(startField.row-endField.row)&&Math.abs(endField.row-this.row)<Math.abs(startField.row-endField.row)}return false};this.inBetween=function(startField,endField){return this.inBetweenCross(startField,endField)||this.inBetweenDiag(startField,endField)}}(function init(){var boardOrientation,row,column;boardOrientation=sync?sync.playerIsWhite:1;$("#board td").each(function(index,element){row=Math.abs(Math.floor(index/8)-7*boardOrientation)+1;column=Math.abs(index%8-7*Math.abs(boardOrientation-1))+1;element.setAttribute("id",column+""+row);field[column]=field[column]||{};field[column][row]=new Field(element)});$("th").each(function(index,element){element.innerHTML=index<8?Math.abs(index-7*boardOrientation)+1:String.fromCharCode(96+Math.abs(index-8-7*Math.abs(boardOrientation-1))+1)});if(savedGame){whitesTurn=savedGame.whitesTurn;gameState=savedGame.gameState;castlingAllowed=savedGame.castlingAllowed;gameTime=savedGame.gameTime;moves=savedGame.moves;$.each(moves,function(index,move){if(move.capturedPieceSymbol){$('<li><div class="piece '+pieceSymbols[move.capturedPieceSymbol].color+" "+pieceSymbols[move.capturedPieceSymbol].kind+'">'+move.capturedPieceSymbol+"</div></li>").appendTo($("#"+pieceSymbols[move.capturedPieceSymbol].color+"Cemetery"))}});if(moves.length&&(moves[moves.length-1].mate||moves[moves.length-1].stalemate)){gameOver=true;if(moves[moves.length-1].mate){$("#end > .tone100 > h2 > span:first-child").css("background-position",whitesTurn?"30% 100%":"0 100%");$("#end > .tone100 > h2 > span:last-child").html(whitesTurn?"Black wins":"White wins")}else{$("#end > .tone100 > h2 > span:first-child").css("background-position","60% 100%");$("#end > .tone100 > h2 > span:last-child").html("Stalemate")}}}gameState=gameState||{1:{1:"♖",2:"♙",7:"♟",8:"♜"},2:{1:"♘",2:"♙",7:"♟",8:"♞"},3:{1:"♗",2:"♙",7:"♟",8:"♝"},4:{1:"♕",2:"♙",7:"♟",8:"♛"},5:{1:"♔",2:"♙",7:"♟",8:"♚"},6:{1:"♗",2:"♙",7:"♟",8:"♝"},7:{1:"♘",2:"♙",7:"♟",8:"♞"},8:{1:"♖",2:"♙",7:"♟",8:"♜"}};$.each(field,function(columnIndex,column){$.each(column,function(rowIndex,fld){if(gameState[columnIndex]&&gameState[columnIndex][rowIndex]){field[columnIndex][rowIndex].createPiece(gameState[columnIndex][rowIndex])}})});$("td > .piece").each(function(index,piece){pieceObject(piece).updateReachables()});$("td > .white.knight:first, td > .black.knight:first").css("transform","scaleX(-1)");$("td > .piece").each(function(index,element){if(!sync||sync.playerIsWhite===pieceObject(element).isWhite){$(element).draggable({containment:$("#board"),revert:"invalid",start:function(event,ui){return pieceObject(ui.helper[0]).startDragging()}});$(element).on("click",function(){return pieceObject(this).clickPiece()})}});$("#board td").droppable({addClasses:false,accept:"",activeClass:"acceptable",drop:function(event,ui){return pieceObject(ui.draggable[0]).move(fieldObject(this))}});$("#border").hover(function(){if(!menu){showCaptionInterval=setTimeout(function(){$("#border table").fadeIn(300)},500)}},function(){$("#border table").fadeOut(300);clearInterval(showCaptionInterval)});updateInfoDrawer();updateGameTime();showInfoDrawer();if(!gameOver){timerInterval=setInterval(function(){updateGameTime()},1e3)}})();return{gameOver:gameOver,deinit:function(){localStorage.clear();if(!controller.autoSave){localStorage.noAutoSave=true}hidePromotionMenu();$(".piece").fadeOut(300,function(){$(this).parent("li").remove();$(this).remove()});$(".ui-draggable").draggable("destroy");$("#board td").droppable("destroy");$("#board td").removeClass();clearInterval(timerInterval);hideInfoDrawer();$("#border").off()},fieldIsTaken:function(column,row){if(field[column]&&field[column][row]&&field[column][row].piece){return true}return false},receiveCoordinates:function(startColumn,startRow,endColumn,endRow,promotionType,preanimation){var startField;var targetField;var piece;var validMove=false;startField=document.getElementById(startColumn+""+startRow);targetField=document.getElementById(endColumn+""+endRow);piece=startField.firstChild;if(!startField||!targetField||!piece){return false}$.each(pieceObject(piece).accessibleFields(),function(index,fld){if(fieldObject(targetField)===fld){validMove=true}});if(preanimation){controller.blink(piece,2,1e3,function(){pieceObject(piece).animateMove(fieldObject(targetField),promotionType)})}else{pieceObject(piece).animateMove(fieldObject(targetField),promotionType)}return validMove},updateLocalStorage:function(){localStorage.whitesTurn=whitesTurn;localStorage.gameState=JSON.stringify(gameState);localStorage.castlingAllowed=JSON.stringify(castlingAllowed);localStorage.gameTime=gameTime;localStorage.moves=JSON.stringify(moves)}}}function Sync(){var gameName;var syncInterval;var windowHasFocus=1;function toggleTitleNotification(){document.title=document.title==="PlainChess"&&!windowHasFocus?"Your turn!":"PlainChess";if(!windowHasFocus){setTimeout(function(){toggleTitleNotification()},1e3)}}(function init(){$(window).on("focus",function(){windowHasFocus=1});$(window).on("blur",function(){windowHasFocus=0})})();return{playerIsWhite:1,deinit:function(){clearInterval(syncInterval);$(window).off()},hostGame:function(name){$.post("php/hostGame.php",{id:name},function(data){if(!data){menu.error(document.getElementById("hostGameName"),"Name already taken…")}else{gameName=data;$("#hostGame > input[type='button']")[0].value="";$("#hostGame > input[type='button']").css("background","#5a4232 url(img/ajax-loader.gif) center no-repeat");$("input[type='text']").attr("readonly",true);$("input[type='button']").attr("disabled",true);menu.deinit();syncInterval=setInterval(function(){sync.waitForStart()},5e3);localStorage.gameName=gameName;localStorage.playerIsWhite=sync.playerIsWhite}})},joinGame:function(name){$.post("php/joinGame.php",{id:name},function(data){if(!data){menu.error(document.getElementById("joinGameName"),"Game not hosted…")}else{sync.playerIsWhite=0;gameName=data;game=new Game;menu.disappear(true);syncInterval=setInterval(function(){sync.waitForMove()},5e3);localStorage.gameName=gameName;localStorage.playerIsWhite=sync.playerIsWhite}})},resumeGame:function(){if(!localStorage.gameName||!localStorage.playerIsWhite){return false}gameName=localStorage.gameName;sync.playerIsWhite=parseInt(localStorage.playerIsWhite,10);if(localStorage.whitesTurn!=sync.playerIsWhite){syncInterval=setInterval(function(){sync.waitForMove()},5e3)}},waitForStart:function(){$.post("php/waitForStart.php",{id:gameName},function(data){if(data==="joined"){toggleTitleNotification();menu.disappear(true);game=new Game;clearInterval(syncInterval)}})},waitForMove:function(){var startColumn,startRow,endColumn,endRow,promotionType;function passMove(preanimation){if(!game.receiveCoordinates(startColumn,startRow,endColumn,endRow,promotionType,preanimation)){alert("Invalid move received, maybe due to cheating. Games might be out of sync, restart is recommended.")}}$.post("php/waitForMove.php",{id:gameName},function(data){if(data!=="joined"){startColumn=parseInt(data.substr(0,1),10);startRow=parseInt(data.substr(1,1),10);endColumn=parseInt(data.substr(3,1),10);endRow=parseInt(data.substr(4,1),10);if(data.substr(6,1)){promotionType=data.substr(6,1)}if(game.fieldIsTaken(startColumn,startRow)){clearInterval(syncInterval);if(windowHasFocus){passMove(0)}else{toggleTitleNotification();$(window).on("focus",function(){windowHasFocus=1;passMove(1);$(window).off("focus");$(window).on("focus",function(){windowHasFocus=1})})}}}})},makeMove:function(move){$.post("php/makeMove.php",{id:gameName,startColumn:move.startColumn,startRow:move.startRow,endColumn:move.endColumn,endRow:move.endRow,promotionType:move.promotionType,gameOver:game.gameOver},function(data){if(!data){alert("Error occured during sync! Game might have ended!")}else{syncInterval=setInterval(function(){sync.waitForMove()},5e3)}})}}}function Menu(name){var menuBox,stripes,textFields,buttons,quickOptions,locked;menuBox=$(name);stripes=menuBox.children();textFields=stripes.children("input[type='text']");buttons=stripes.children("input[type='button']");quickOptions=stripes.children("h2").children("a");locked=0;function highlightStripe(number){if(locked){return false}stripes.each(function(index,element){$(element).children().clearQueue();if(number===index+1||!number){$(element).children().fadeTo(300,1)}else{$(element).children().fadeTo(300,.3)}})}function init(){var code;menuBox.on("mouseleave",function(handler){highlightStripe(0)});stripes.each(function(index,element){if(element.id){$(element).on("mouseenter",function(){highlightStripe(index+1)});$(element).on("click",function(){$(element).children("input[type='text']").focus();highlightStripe(index+1)})}else{$(element).on("mouseenter",function(){highlightStripe(0)})}$(element).children().each(function(childIndex,childElement){$(childElement).on("focus",function(){highlightStripe(index+1);locked=1});$(childElement).on("blur",function(){locked=0;highlightStripe(0)})})});textFields.each(function(index,element){$(element).on("focus",function(){if(element.value===element.getAttribute("value")){element.value=""}});$(element).on("blur",function(){if(element.value===""||$(element).hasClass("error")){element.value=element.getAttribute("value");$(element).removeClass("error")}});$(element).on("keypress",function(key){code=key.keyCode?key.keyCode:key.which;if(code!==13){if($(element).hasClass("error")){element.value="";$(element).removeClass("error");return true}return true}menu.menuOption(element.parentNode.id)})});buttons.each(function(index,element){$(element).on("click",function(){menu.menuOption(element.parentNode.id)})});quickOptions.each(function(index,element){$(element).on("click",function(){menu.menuOption(element.parentNode.parentNode.id);return false})});menu.initialized=true}return{name:name,initialized:false,deinit:function(){menuBox.off();$(stripes).off();$(stripes).children().off();$(quickOptions).off()},appear:function(animated){menuBox.show();if(animated){stripes.each(function(index,element){$(element).css("left","-480px").animate({left:"0"},500+index*100,"easeOutQuad",function(){if(index===stripes.length-1){init()}})})}else{init()}},disappear:function(animated){menu.deinit();function deinitAfterAnimation(){menuBox.hide();if(menu){menu=undefined}$("input[type='text']")[0].value=$("input[type='text']")[0].getAttribute("value");$("#hostGame > input[type='button']")[0].value="Go";$("#hostGame > input[type='button']").css("background","");$("input[type='text']").attr("readonly",false);$("input[type='button']").attr("disabled",false)}if(animated){stripes.each(function(index,element){$(element).animate({left:"480px"},400+100*(stripes.length-index),"easeInQuad",function(){if(!index){deinitAfterAnimation()}})})}else{deinitAfterAnimation()}if(menu){menu.initialized=false}},error:function(input,msg){input.value="";input.placeholder=msg;$(input).addClass("error").focus()},menuOption:function(optionId){var name;switch(optionId){case"hostGame":name=document.getElementById("hostGameName").value.trim();if(!name){return menu.error(document.getElementById("hostGameName"),"Enter game name…")}sync=new Sync;sync.hostGame(name);break;case"joinGame":name=document.getElementById("joinGameName").value.trim();if(!name){return menu.error(document.getElementById("joinGameName"),"Enter game name…")}sync=new Sync;sync.joinGame(name);break;case"playOffline":game=new Game;menu.disappear(true);break;case"toggleAutoSave":if(sync){break}controller.autoSave=!controller.autoSave;if(controller.autoSave){localStorage.noAutoSave=undefined;game.updateLocalStorage()}else{localStorage.noAutoSave=true}$("#toggleAutoSave > h2 > a > span:last-child").html(controller.autoSave?"on":"off");controller.flip($("#pause > .tone55 > h2 span:first-child"),"horizontal",250,function(){$("#pause > .tone55 > h2 span:first-child").css("background-position",controller.autoSave?"60% 57.14%":"100% 85.71%")});break;case"playOn":menu.disappear(true);break;case"quitGame":game=game.deinit();if(sync){sync=sync.deinit()}menu=menu.disappear();menu=new Menu("#start");menu.appear(true);break}}}}controller=function(){function toggleMenu(animated){if($("#toggleFaq").hasClass("active")){$("#toggleFaq").click();return false}if(menu){if(menu.name!=="#start"&&menu.initialized){menu.disappear(animated)}}else{menu=new Menu(game.gameOver?"#end":"#pause");menu.appear(animated)}}(function init(){var savedGame;if(localStorage.gameState||localStorage.gameName){if(localStorage.gameState){savedGame={};savedGame.whitesTurn=parseInt(localStorage.whitesTurn,10);savedGame.gameTime=parseInt(localStorage.gameTime,10);try{savedGame.gameState=JSON.parse(localStorage.gameState);savedGame.castlingAllowed=JSON.parse(localStorage.castlingAllowed);savedGame.moves=JSON.parse(localStorage.moves)}catch(error){localStorage.clear();savedGame=undefined}}if(localStorage.gameName){sync=new Sync;sync.resumeGame()}game=new Game(savedGame);toggleMenu(false)}else{menu=new Menu("#start");menu.appear()}$("h1 a").on("click",function(){toggleMenu(true);return false});$(document).on("keydown",function(key){if(key.keyCode===27||key.which===27){toggleMenu(true);return false}});$("#toggleAwareness").on("click",function(){if($("#chess").hasClass("awareness")){$("#chess").removeClass("awareness")}else{$("#chess").addClass("awareness")}});$("#toggleFaq").on("click",function(){$("#toggleFaq").toggleClass("active");$("#flip").toggleClass("flipped");return false});$("#contact").on("click",function(){$("#contact").off();controller.flip($("#contact"),"vertical",250,function(){$("#contact").html("plainchess@timwoelfle.de");$("#contact").attr("href","mailto:plainchess@timwoelfle.de?subject=PlainChess")});return false});if(localStorage.noAutoSave&&!sync){$("#toggleAutoSave > h2 > a > span:last-child").html("off");$("#pause > .tone55 > h2 span:first-child").css("background-position","100% 85.71%")}})();return{autoSave:!(localStorage.noAutoSave&&!sync),blink:function(element,count,durationEach,callback){$(element).animate({opacity:"0"},durationEach/2,"easeOutQuad",function(){$(element).animate({opacity:"1"},durationEach/2,"easeInQuad",function(){if(count>1){controller.blink(element,count-1,durationEach,callback)}else{if(typeof callback==="function"){callback()}}})})},spin:function(element,duration){$(element).css("transition-property","transform").css("transition-duration",duration+"ms").css("transition-timing-function","ease-out");setTimeout(function(){$(element).css("transform","rotate(360deg)")})},flip:function(element,className,duration,callback){$(element).on("transitionend",function(){$(element).off("transitionend");$(element).css("transition-timing-function","ease-out").removeClass(className);if(typeof callback==="function"){callback()}}).css("transition-property","transform").css("transition-duration",duration/2+"ms").css("transition-timing-function","ease-in");setTimeout(function(){$(element).addClass(className)})}}}();